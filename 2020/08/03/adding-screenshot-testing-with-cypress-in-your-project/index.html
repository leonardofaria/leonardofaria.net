<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hugo.leonardofaria.net><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>Adding screenshot testing with Cypress in your project &#183; Leonardo Faria</title><meta property="og:title" content="Adding screenshot testing with Cypress in your project &#183; Leonardo Faria"><meta name=twitter:title content="Adding screenshot testing with Cypress in your project &#183; Leonardo Faria"><meta itemprop=name content="Adding screenshot testing with Cypress in your project &#183; Leonardo Faria"><meta name=application-name content="Leonardo Faria"><meta property="og:site_name" content="Leonardo Faria"><base href=https://hugo.leonardofaria.net/2020/08/03/adding-screenshot-testing-with-cypress-in-your-project/><link rel=canonical href=https://hugo.leonardofaria.net/2020/08/03/adding-screenshot-testing-with-cypress-in-your-project/ itemprop=url><meta name=url content="https://hugo.leonardofaria.net/2020/08/03/adding-screenshot-testing-with-cypress-in-your-project/"><meta name=twitter:url content="https://hugo.leonardofaria.net/2020/08/03/adding-screenshot-testing-with-cypress-in-your-project/"><meta property="og:url" content="https://hugo.leonardofaria.net/2020/08/03/adding-screenshot-testing-with-cypress-in-your-project/"><meta itemprop=image content="https://hugo.leonardofaria.net/images/og-images/2209.png"><meta property="og:image" content="https://hugo.leonardofaria.net/images/og-images/2209.png"><meta name=twitter:image content="https://hugo.leonardofaria.net/images/og-images/2209.png"><meta name=twitter:image:src content="https://hugo.leonardofaria.net/images/og-images/2209.png"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="Developers are usually concerned about the quality of their code. There are different kinds of tests to avoid breaking code when a new feature is added in a pro"><meta property="og:description" content="Developers are usually concerned about the quality of their code. There are different kinds of tests to avoid breaking code when a new feature is added in a pro"><meta name=description content="Developers are usually concerned about the quality of their code. There are different kinds of tests to avoid breaking code when a new feature is added in a pro"><meta name=twitter:description content="Developers are usually concerned about the quality of their code. There are different kinds of tests to avoid breaking code when a new feature is added in a pro"><meta property="article:published_time" content="2020-08-03T00:00:00Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="8 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="August 3, 2020"><meta property="article:tag" content="javascript"><meta property="og:updated_time" content="2020-08-03T00:00:00Z"><meta property="og:article:author" content="Leonardo Faria"><meta property="article:author" content="Leonardo Faria"><meta name=author content="Leonardo Faria"><meta name=generator content="Hugo 0.73.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hugo.leonardofaria.net/css/styles.min.0f1a07fa6013988f3640ab8076347106f984a80a42c9bd9b2009cfda32a8e9a3.css integrity="sha256-DxoH+mATmI82QKuAdjRxBvmEqApCyb2bIAnP2jKo6aM="><link href=/index.xml rel=alternate type=application/rss+xml title="Leonardo Faria"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script><link rel=webmention href=https://webmention.io/leonardofaria.net/webmention><link rel=pingback href=https://webmention.io/leonardofaria.net/xmlrpc><script src=https://hugo.leonardofaria.net/js/webmentions.min.08cc9bae8a99aae297e64b2c62dafb59df5b79edbd86de6b52528a752a4cd499.js type=text/javascript></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hugo.leonardofaria.net/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Leonardo Faria</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/leozera rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/leonardofaria rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/leonardofariacoelho rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Email href=mailto:leonardofaria@gmail.com><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/feed><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Archives class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/archives>Archives</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Portfolio class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/portfolio>Portfolio</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Talks class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/talks>Talks</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2020-08-03T00:00:00+00:00>August 3, 2020</time>
<a href=https://hugo.leonardofaria.net/tags/javascript/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">javascript</a></small><h1 class="leading-9 text-center"><a href=https://hugo.leonardofaria.net/2020/08/03/adding-screenshot-testing-with-cypress-in-your-project/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>Adding screenshot testing with Cypress in your project</a></h1></header><div class=article__content><p>Developers are usually concerned about the quality of their code. There are different kinds of tests to avoid breaking code when a new feature is added in a project, however, what can be done to ensure that components don&rsquo;t look different over time?</p><p>In this post, you will learn how to use Cypress to capture parts of pages of a website and after that, you will integrate the testing tool in CI to ensure that in the future no one will bring unwanted changes in the project.</p><p>My motivation for creating this testing strategy came from work. At <a href=https://www.thinkific.com>Thinkific</a> we have an internal Design System and we added Cypress to avoid surprises when working in CSS/JS files.</p><p>By the end of this post we will have PRs with Cypress tests:</p><p><img src=/wp-content/uploads/2020/08/cypress-bot-comment.jpg alt="Cypress bot"></p><h2 id=before-we-start>Before we start</h2><p>I created a <a href=https://cypress-example.vercel.app/>sample website</a> to mimic a Component Library. It is a very simple website created with TailwindCSS and hosted in Vercel and it documents 2 components: <a href=https://cypress-example.vercel.app/badge.html>badge</a> and <a href=https://cypress-example.vercel.app/button.html>button</a>.</p><p>You can check the <a href=https://github.com/leonardofaria/cypress-example>source code</a> in GitHub. The website is static and it is inside the <code>public</code> folder. You can see the website locally by running <code>npm run serve</code> and checking in the browser <a href=http://localhost:8000>http://localhost:8000</a>.</p><p><img src=/wp-content/uploads/2020/08/cypress-sample-website.png alt="Sample website"></p><h2 id=adding-cypress-and-cypress-image-snapshot>Adding Cypress and Cypress Image Snapshot</h2><p>Start by cloning the <a href=https://github.com/leonardofaria/cypress-example>example repository</a>. Next, create a new branch and install <a href=https://www.npmjs.com/package/cypress-image-snapshot>Cypress Image Snapshot</a>, the package responsible for capturing/comparing screenshots.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git checkout -b add-cypress
npm install -D cypress cypress-image-snapshot
</code></pre></div><p>After adding the packages, a few extra steps are needed to add Cypress Image Snapshot in Cypress.</p><p>Create a <code>cypress/plugins/index.js</code> file with the following content:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000;font-weight:700>const</span> { addMatchImageSnapshotPlugin } <span style=color:#000;font-weight:700>=</span> require(<span style=color:#d14>&#39;cypress-image-snapshot/plugin&#39;</span>);

module.exports <span style=color:#000;font-weight:700>=</span> (on, config) =&gt; {
  addMatchImageSnapshotPlugin(on, config);
};

</code></pre></div><p>Next, create a <code>cypress/support/index.js</code> file containing:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000;font-weight:700>import</span> { addMatchImageSnapshotCommand } from <span style=color:#d14>&#39;cypress-image-snapshot/command&#39;</span>;

addMatchImageSnapshotCommand();
</code></pre></div><h2 id=creating-the-screenshot-test>Creating the screenshot test</h2><p>Time to create the screenshot test. Here is the plan:</p><ol><li>Cypress will visit each page (badge and button) of the project.</li><li>Cypress will take a screenshot of each example in the page. The <a href=https://cypress-example.vercel.app/badge.html>Badge page</a> has 2 examples (Default and Pill), while the <a href=https://cypress-example.vercel.app/badge.html>Button page</a> has 3 examples (Default, Pill and Outline). All these examples are inside an <code>&lt;div></code> element with a <code>cypress-wrapper</code>. This class was added with the only intention to identify what needs to be tested.</li></ol><p>The first step is creating Cypress configuration file (<code>cypress.json</code>):</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:navy>&#34;baseUrl&#34;</span>: <span style=color:#d14>&#34;http://localhost:8000/&#34;</span>,
  <span style=color:navy>&#34;video&#34;</span>: <span style=color:#000;font-weight:700>false</span>
}
</code></pre></div><p>The <code>baseUrl</code> is the website running locally. As I mentioned before, <code>npm run serve</code> will serve the content of the <code>public</code> folder. The second option, <code>video</code> disables Cypress video recording, which won&rsquo;t be used in the project.</p><p>Time to create the test. In <code>cypress/integration/screenshot.spec.js</code>, add:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000;font-weight:700>const</span> routes <span style=color:#000;font-weight:700>=</span> [<span style=color:#d14>&#39;badge.html&#39;</span>, <span style=color:#d14>&#39;button.html&#39;</span>];

describe(<span style=color:#d14>&#39;Component screenshot&#39;</span>, () =&gt; {
  routes.forEach((route) =&gt; {
    <span style=color:#000;font-weight:700>const</span> componentName <span style=color:#000;font-weight:700>=</span> route.replace(<span style=color:#d14>&#39;.html&#39;</span>, <span style=color:#d14>&#39;&#39;</span>);
    <span style=color:#000;font-weight:700>const</span> testName <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>`</span><span style=color:#d14>${</span>componentName<span style=color:#d14>}</span><span style=color:#d14> should match previous screenshot`</span>;

    it(testName, () =&gt; {
      cy.visit(route);
  
      cy.get(<span style=color:#d14>&#39;.cypress-wrapper&#39;</span>).each((element, index) =&gt; {
        <span style=color:#000;font-weight:700>const</span> name <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>`</span><span style=color:#d14>${</span>componentName<span style=color:#d14>}</span><span style=color:#d14>-</span><span style=color:#d14>${</span>index<span style=color:#d14>}</span><span style=color:#d14>`</span>;
  
        cy.wrap(element).matchImageSnapshot(name);
      });
    });
  });
});
</code></pre></div><p>In the code above, I am creating dynamically tests based in the <code>routes</code> array. The test will create one image per <code>.cypress-wrapper</code> element that the page has.</p><p>Last, let&rsquo;s create inside the <code>package.json</code> the command to trigger the tests:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:navy>&#34;test&#34;</span>: <span style=color:#d14>&#34;cypress&#34;</span>
}  
</code></pre></div><p>From here, there are 2 options: run Cypress in headless mode with <code>npm run cypress run</code> or use the Cypress Test Runner with <code>npm run cypress open</code>.</p><h3 id=headless-option>Headless option</h3><p>Using <code>npm run cypress run</code>, the output should be similar to the next image:</p><p><img src=/wp-content/uploads/2020/08/cypress-first-test.jpg alt="Output of first test"></p><p>The tests will pass and 5 images will be created under <code>/snapshots/screenshot.spec.js</code> folder.</p><h3 id=test-runner-option>Test Runner option</h3><p>Using <code>npm run cypress open</code>, Cypress Test Runner will be opened and you can follow step by step the tests.</p><p><img src=/wp-content/uploads/2020/08/cypress-test-runner.jpg alt="Cypress Test Runner screenshot"></p><p>Our first milestone is done, let&rsquo;s merge this branch to master. If you want to see the work done so far, jump in my <a href=https://github.com/leonardofaria/cypress-example/pull/1>Pull Request</a>.</p><h2 id=using-cypress-inside-docker>Using Cypress inside Docker</h2><p>If you run the test above alternating between headless and Test Runner, you may notice that screenshot will vary. Using the Test Runner with a retina display computer, you may get retina images (2x), while the headless mode doesn&rsquo;t give you high-quality screenshots.</p><p>Also, it is important to say the screenshots may vary according to the Operational System. Linux and Windows, for instance, have apps with visible scrollbars, while macOS hides the scrollbar. If the content captured in the screenshot doesn&rsquo;t fit a component, you may or may not have a scrollbar. If your project relies on OS default fonts, screenshots will also be different according to the environment.</p><p>In order to avoid these inconsistencies, tests will run inside Docker so the developer computer won&rsquo;t affect in the screenshots captures.</p><p>Let&rsquo;s start by creating a new branch:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git checkout -b add-docker
</code></pre></div><p>Cypress offers different Docker images - you can check details in <a href=https://docs.cypress.io/examples/examples/docker.html>their documentation</a> and <a href=https://www.cypress.io/blog/2019/05/02/run-cypress-with-a-single-docker-command/>their blog</a>. For this example, I will use the <code>cypress/included</code> image, which includes Electron and it is ready to be used.</p><p>Two changes will be needed: change the <code>baseUrl</code> in the <code>cypress.json</code> file:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:navy>&#34;baseUrl&#34;</span>: <span style=color:#d14>&#34;http://host.docker.internal:8000/&#34;</span>,
}
</code></pre></div><p>and the <code>test</code> command in the <code>package.json</code> file:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:navy>&#34;test&#34;</span>: <span style=color:#d14>&#34;docker run -it -e CYPRESS_updateSnapshots=$CYPRESS_updateSnapshots --ipc=host -v $PWD:/e2e -w /e2e cypress/included:4.11.0&#34;</span>
}
</code></pre></div><p>Running <code>npm run test</code> will bring us a problem:</p><p><img src=/wp-content/uploads/2020/08/cypress-docker.jpg alt="Output of test"></p><p>The images are slightly different but why? Let&rsquo;s see what is inside the <code>__diff_output__</code> folder:</p><p><img src=/wp-content/uploads/2020/08/cypress-button-diff.png alt="Button&rsquo;s difference"></p><p>As I mentioned earlier, typography inconsistencies! The Button component uses the OS default font. Since Docker is running inside Linux, the rendered font won&rsquo;t be the same that I have installed on macOS.</p><p>Since now we moved to Docker, these screenshots are outdated. Time to update the snapshots:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:teal>CYPRESS_updateSnapshots</span><span style=color:#000;font-weight:700>=</span><span style=color:#0086b3>true</span> npm run <span style=color:#0086b3>test</span>
</code></pre></div><p>Please notice that I am prefixing the test command with the environment variable <code>CYPRESS_updateSnapshots</code>.</p><p>The second milestone is done. In case you need help, check my <a href=https://github.com/leonardofaria/cypress-example/pull/2>pull request</a>.</p><p>Let&rsquo;s merge this branch and move forward.</p><h2 id=adding-ci>Adding CI</h2><p>Our next step is adding the tests in CI. There are different CI solutions in the market but for this tutorial, I will use Semaphore. I am not affiliated to them and I use their product at work, so it was for me a natural choice. The configuration is straightforward and it can be adapted to other solutions like CircleCI or Github Actions.</p><p>Before we create our Semaphore configuration file, let&rsquo;s prepare our project to run in CI.</p><p>The first step is installing <a href=https://www.npmjs.com/package/start-server-and-test>start-server-and-test</a>. As the package name says, it will start a server, waits for URL, then runs a test command:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>npm install -D start-server-and-test
</code></pre></div><p>Second, edit the <code>package.json</code> file:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:navy>&#34;test&#34;</span>: <span style=color:#d14>&#34;docker run -it -e CYPRESS_baseUrl=$CYPRESS_baseUrl -e CYPRESS_updateSnapshots=$CYPRESS_updateSnapshots --ipc=host -v $PWD:/e2e -w /e2e cypress/included:4.11.0&#34;</span>,
  <span style=color:navy>&#34;test:ci&#34;</span>: <span style=color:#d14>&#34;start-server-and-test serve http://localhost:8000 test&#34;</span>
}
</code></pre></div><p>In the <code>test</code> script, we are adding the <code>CYPRESS_baseUrl</code> environment variable. This will allow us to change the base URL used by Cypress dynamically. Also, we are adding the <code>test:ci</code> script, which will run the package we just installed.</p><p>We are ready for Semaphore. Create the <code>.semaphore/semaphore.yml</code> file with the following content:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#000;font-weight:700>version</span>:<span style=color:#bbb> </span>v1<span style=color:#099>.0</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>name</span>:<span style=color:#bbb> </span>Cypress<span style=color:#bbb> </span>example<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>agent</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>machine</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>type</span>:<span style=color:#bbb> </span>e1-standard<span style=color:#099>-2</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>os_image</span>:<span style=color:#bbb> </span>ubuntu1804<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>blocks</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#bbb>  </span>- <span style=color:#000;font-weight:700>name</span>:<span style=color:#bbb> </span>Build<span style=color:#bbb> </span>Dependencies<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>dependencies</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>task</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#bbb>      </span><span style=color:#000;font-weight:700>jobs</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#bbb>        </span>- <span style=color:#000;font-weight:700>name</span>:<span style=color:#bbb> </span>NPM<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#bbb>          </span><span style=color:#000;font-weight:700>commands</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#bbb>            </span>- sem-version<span style=color:#bbb> </span>node<span style=color:#bbb> </span><span style=color:#099>12</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#bbb>            </span>- checkout<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#bbb>            </span>- npm<span style=color:#bbb> </span>install<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#bbb>  </span>- <span style=color:#000;font-weight:700>name</span>:<span style=color:#bbb> </span>Tests<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>dependencies</span>:<span style=color:#bbb> </span>[<span style=color:#d14>&#39;Build Dependencies&#39;</span>]<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>task</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#bbb>      </span><span style=color:#000;font-weight:700>prologue</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>commands</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:#bbb>          </span>- sem-version<span style=color:#bbb> </span>node<span style=color:#bbb> </span><span style=color:#099>12</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:#bbb>          </span>- checkout<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:#bbb>      </span><span style=color:#000;font-weight:700>jobs</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span style=color:#bbb>        </span>- <span style=color:#000;font-weight:700>name</span>:<span style=color:#bbb> </span>Cypress<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span style=color:#bbb>          </span><span style=color:#000;font-weight:700>commands</span>:<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:#bbb>            </span>- export<span style=color:#bbb> </span>CYPRESS_baseUrl=<span style=color:#d14>&#34;http://$(ip route | grep -E &#39;(default|docker0)&#39; | grep -Eo &#39;([0-9]+\.){3}[0-9]+&#39; | tail -1):8000&#34;</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span style=color:#bbb>            </span>- npm<span style=color:#bbb> </span>run<span style=color:#bbb> </span>test:ci</code></pre></div><p>Breaking the configuration in details:</p><ul><li>The lines 1-6 defines which kind of instance we will use in their environment;</li><li>The lines 8 and 16 create 2 blocks: the first block, &ldquo;Build Dependencies&rdquo; will run <code>npm install</code>, downloading the dependencies we need. The second block, &ldquo;Tests&rdquo; will run Cypress, with a few differences.</li><li>In line 27, we are dynamically setting the <code>CYPRESS_baseUrl</code> environment variable based in the IP Docker is using at the moment. This will replace <code>http://host.docker.internal:8000/</code>, which may not work in all environments.</li><li>In line 28, we finally run the test using <code>start-server-and-test</code>: once the server is ready for connections, Cypress will run the test suite.</li></ul><p>Another milestone is done, time to merge our branch! You can check the <a href=https://github.com/leonardofaria/cypress-example/pull/6/files>Pull request</a> that contains all the files from this section and check the <a href=https://leonardofaria.semaphoreci.com/workflows/061f6c9f-8f2d-4351-8a25-e5bc1568f67e>build inside Semaphore</a>.</p><h2 id=recording-the-tests-in-cypressio>Recording the tests in cypress.io</h2><p>Reading the output of tests in CI is not very friendly. In this step, we will integrate our project with <a href=https://www.cypress.io/>cypress.io</a>.</p><p>The following steps are based on <a href=https://docs.cypress.io/guides/dashboard/projects.html#Setup>Cypress documentation</a>.</p><p>Let&rsquo;s start by getting a project ID and a record key. In the terminal, create a new branch and run:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git checkout -b add-cypress-recording
<span style=color:teal>CYPRESS_baseUrl</span><span style=color:#000;font-weight:700>=</span>http://localhost:8000 ./node_modules/.bin/cypress open
</code></pre></div><p>Earlier I have mentioned we would be using Cypress inside Docker but here we are opening Cypress locally since this is the only way to integrate with the website dashboard.</p><p>Inside Cypress, let&rsquo;s go the Runs tab, click in &ldquo;Set up project to record&rdquo;, choose a name and visibility. We will get a <code>projectId</code> that is automatically added in the <code>cypress.json</code> file and a private record key. Here is a video of the steps:</p><video class=h-auto controls loop autoplay>
<source src=/wp-content/uploads/2020/08/cypress-adding-integration.mp4 type=video/mp4></video><p>In Semaphore, I added the record key as an environment variable called <code>CYPRESS_recordKey</code>. Next let&rsquo;s update our test script to use the variable:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:navy>&#34;test:ci&#34;</span>: <span style=color:#d14>&#34;start-server-and-test &#39;serve&#39; 8000 &#39;npm run test -- run --record --key $CYPRESS_recordKey&#39;&#34;</span>
}
</code></pre></div><p>That is pretty much all that needs to be done. In the <a href=https://github.com/leonardofaria/cypress-example/pull/8>Pull request</a> we can see the cypress.io integration in the comments. There is even a deep link that takes us to their dashboard and shows all the screenshots. Check the video below:</p><video class=h-auto controls loop autoplay>
<source src=/wp-content/uploads/2020/08/cypress-io-test-dashboard.mp4 type=video/mp4></video><p>Time to merge our work and that is the end of our integration.</p><h2 id=testing-in-real-life>Testing in real life</h2><p>Imagine we are working on a change that affects the padding of the buttons: time to test if Cypress will capture the difference.</p><p>In the example website, let&rsquo;s double the horizontal padding from 16px to 32px. This change is quite simple since we are using Tailwind CSS: <code>px-4</code> gets replaced by <code>px-8</code>. Here is <a href=https://github.com/leonardofaria/cypress-example/pull/9>Pull request</a>.</p><p>As we could expect, Cypress captured that the button doesn&rsquo;t match the screenshots. Visiting the page, we can check the screenshot of the broken test:</p><video class=h-auto controls loop autoplay>
<source src=/wp-content/uploads/2020/08/cypress-io-broken-test.mp4 type=video/mp4></video><p>The diff file shows the original screenshot on the left, the current result on the right and they are combined in the middle. We also have the option to download the image so we can see the issue better:</p><div class=full-width><img alt="Button before and after" src=/wp-content/uploads/2020/08/cypress-io-broken-test.png></div><p>If this is not an issue, update the screenshots:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:teal>CYPRESS_updateSnapshots</span><span style=color:#000;font-weight:700>=</span><span style=color:#0086b3>true</span> npm run <span style=color:#0086b3>test</span>
</code></pre></div><h2 id=the-end>The end</h2><p>That&rsquo;s it for today. I hope you have learned how Cypress can be useful to ensure no one is adding unexpected changes in a project.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/avatar.jpg>
<span class=flex-grow>If you like my content, follow me on <a class="transition duration-300 ease-in-out hover:text-blue-600" href=https://twitter.com/leozera>Twitter</a> and <a class="transition duration-300 ease-in-out hover:text-blue-600" href=https://github.com/leonardofaria>GitHub</a></span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhugo.leonardofaria.net%2f2020%2f08%2f03%2fadding-screenshot-testing-with-cypress-in-your-project%2f&text=Adding%20screenshot%20testing%20with%20Cypress%20in%20your%20project&via=leozera" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2><h3>Webmentions</h3><div id=summary class="flex items-center"><button id=button-likes-2a89a9a05219ce7f9496e8ad62d7b48a class="flex items-center mr-6 p-3 bg-gray-100 hover:bg-white transition duration-300 ease-in-out rounded-md"><svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656.0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
<span id=webmentions-total-likes class=mr-1></span></button>
<button id=button-interactions-2a89a9a05219ce7f9496e8ad62d7b48a class="flex items-center mr-6 p-3 bg-gray-100 hover:bg-white transition duration-300 ease-in-out rounded-md"><svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4A2 2 0 002 5v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6A1 1 0 015 7zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>
<span id=webmentions-total-interactions class=mr-1></span></button><div class=flex-grow><div id=webmentions-avatars class="flex -space-x-2 overflow-hidden"></div></div></div><template id=reply-template class=list-none><li class="flex mb-8 text-base"><a class="js-author flex-shrink-0" href><img class="js-avatar w-8 h-8 rounded-full mr-3" alt src></a><div><div><strong><a class="js-author-name no-underline" href></a></strong><small><a class="js-date js-source no-underline ml-2" href></a></small></div><div class=js-content></div></div></li></template><template id=like-template class=list-none><li class="flex mb-8 text-base"><a class="js-author flex-shrink-0" href><img class="js-avatar w-8 h-8 rounded-full mr-3" alt src></a>
<a class="js-source no-underline" href><span class="js-sentence js-author-name" href></span><small class="js-date ml-2" href></small></a></li></template><div id=webmentions-interactions-2a89a9a05219ce7f9496e8ad62d7b48a class=hidden><h4>Replies & Shares</h4><ul id=replies></ul><ul id=shares></ul></div><div id=webmentions-likes-2a89a9a05219ce7f9496e8ad62d7b48a class=hidden><h4>Likes</h4><ul id=likes></ul></div><script type=text/javascript>var webmentions=(permalink,aliases,productionBaseUrl)=>{fetchWebmentions(permalink,aliases,productionBaseUrl);document.querySelector('#button-interactions-2a89a9a05219ce7f9496e8ad62d7b48a').addEventListener('click',()=>{document.querySelector('#webmentions-interactions-2a89a9a05219ce7f9496e8ad62d7b48a').classList.toggle('hidden');});document.querySelector('#button-likes-2a89a9a05219ce7f9496e8ad62d7b48a').addEventListener('click',()=>{document.querySelector('#webmentions-likes-2a89a9a05219ce7f9496e8ad62d7b48a').classList.toggle('hidden');});};document.addEventListener('turbolinks:load',webmentions("https://hugo.leonardofaria.net/2020/08/03/adding-screenshot-testing-with-cypress-in-your-project/",null,"https://leonardofaria.net"));</script><h3>Comments</h3><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"leonardofaria"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/2020/08/13/automating-accessibility-tests-with-cypress/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Automating accessibility tests with Cypress</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/2020/07/29/bento-theme-released/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>Bento theme released</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-157386-6','auto');ga('send','pageview');}</script><script async defer data-website-id=ef25ee64-202b-4378-822f-22398533a59c src=https://umami.leonardofaria.net/umami.js></script></body></html>